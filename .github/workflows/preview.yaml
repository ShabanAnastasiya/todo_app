name: Preview

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed
    branches:
      - main
      - pre-prod
      - stage
      - develop
    paths:
      - 'supabase/**'

jobs:
  manage_branch:
    runs-on: ubuntu-latest
    
    # Only run the job if the PR is NOT closed, or if it is closed for destruction
    if: github.event.action != 'closed' || github.event.action == 'closed'
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_ID: >
        ${{ (github.base_ref == 'main' &&     secrets.PRODUCTION_PROJECT_ID) ||
            (github.base_ref == 'pre-prod' && secrets.PREPROD_PROJECT_ID) ||
            (github.base_ref == 'stage' &&    secrets.STAGE_PROJECT_ID) ||
            (github.base_ref == 'develop' &&  secrets.DEVELOP_PROJECT_ID) }}
    outputs:
      # These outputs will be automatically set by the action
      db_pass: ${{ steps.branch.outputs.db_password }}
      ref: ${{ steps.branch.outputs.ref }}
      db_host: ${{ steps.branch.outputs.db_host }}
      
    steps:
      - uses: actions/checkout@v4
      
      # Use a dedicated action to create/delete the branch
      - uses: 0xbigboss/supabase-branch-gh-action@v1 # Example: A community-made Supabase Branching Action
        id: branch
        with:
          supabase-access-token: ${{ env.SUPABASE_ACCESS_TOKEN }}
          supabase-project-id: ${{ env.SUPABASE_PROJECT_ID }}
          git-branch: ${{ github.head_ref }}
          action: ${{ github.event.action }} # Pass the PR event action (opened, closed, etc.)
          wait-for-migrations: true

  migrate:
    needs: manage_branch # Depend on the new job
    runs-on: ubuntu-latest
    if: github.event.action != 'closed' # Only run migrations if the branch was created, not closed
    
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_DB_PASSWORD: ${{ needs.manage_branch.outputs.db_pass }}
      SUPABASE_DB_HOST: ${{ needs.manage_branch.outputs.db_host }}
      SUPABASE_PROJECT_REF: ${{ needs.manage_branch.outputs.ref }}

    steps:
      - uses: actions/checkout@v4
      - uses: supabase/setup-cli@v1
        with:
          version: latest

      # Use the dynamically retrieved credentials to push migrations
      - run: supabase link --project-ref $SUPABASE_PROJECT_REF
      - run: yes | supabase db reset --linked
